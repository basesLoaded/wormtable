

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Data storage &mdash; wormtable 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="wormtable 0.1.0 documentation" href="index.html" />
    <link rel="prev" title="Performance tuning" href="performance.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="performance.html" title="Performance tuning"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">wormtable 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="data-storage">
<span id="data-storage-index"></span><h1>Data storage<a class="headerlink" href="#data-storage" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Release:</th><td class="field-body">0.1</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">July 10, 2013</td>
</tr>
</tbody>
</table>
<p>All data stored in a wormtable is <em>typed</em>: individual elements are either integers,
floating point values or strings of characters. The advantage of this typing system
is that data is stored in a compact binary format, minimising the space used and
also allowing us to efficiently retrieve values from the table.</p>
<p>This page describes the type and sizes of data that may be stored in columns,
as well as some low-level details about this data storage format. While this
information is not directly relevant to programmers using wormtable, it
can help to understand the various tradeoffs when choosing a particular
type or choosing a variable versus a fixed length column.</p>
<div class="section" id="column-types">
<span id="data-types-index"></span><h2>Column types<a class="headerlink" href="#column-types" title="Permalink to this headline">¶</a></h2>
<p>The fundamental storage units of wormtable are <em>rows</em> and <em>columns</em>,
similar to relational databases. A row is split into a fixed number of
columns, and within a column we store some number of <em>elements</em> of a
fixed <em>type</em> and <em>size</em>. The size of the elements determines the range
of the values that can be stored in a column; for example, an unsigned
integer column with element size 1 can store values from 0 up to
254 only.</p>
<p>The number of elements that is stored in a column is
either fixed or variable. In a column with a fixed number of elements,
space is reserved for all of these elements, and so the total space used
by that column is always <em>num_elements</em> * <em>element_size</em>.
In variable length columns, we can store
from 0 to 255 elements.</p>
<div class="section" id="integer-columns">
<span id="int-types-index"></span><h3>Integer columns<a class="headerlink" href="#integer-columns" title="Permalink to this headline">¶</a></h3>
<p>Integer columns with an element size <img class="math" src="_images/math/174fadd07fd54c9afe288e96558c92e0c1da733a.png" alt="n"/>  are <img class="math" src="_images/math/174fadd07fd54c9afe288e96558c92e0c1da733a.png" alt="n"/> byte signed
integers. They can store values in the range <img class="math" src="_images/math/7d85147d98fbc73f0e34429d8823935a5b9dd9cd.png" alt="-2^{8n - 1} + 1 \leq x
\leq 2^{8n - 1} - 1"/>. Element sizes of <img class="math" src="_images/math/dce34f4dfb2406144304ad0d6106c5382ddd1446.png" alt="1"/> up to <img class="math" src="_images/math/8455f3b5cb3b4880b8c9d782a5c1f0334db819eb.png" alt="8"/> are supported.</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="39%" />
<col width="37%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element size</th>
<th class="head">Min</th>
<th class="head">Max</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>-127</td>
<td>127</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>-32767</td>
<td>32767</td>
</tr>
<tr class="row-even"><td>3</td>
<td>-8388607</td>
<td>8388607</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>-2147483647</td>
<td>2147483647</td>
</tr>
<tr class="row-even"><td>5</td>
<td>-549755813887</td>
<td>549755813887</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>-140737488355327</td>
<td>140737488355327</td>
</tr>
<tr class="row-even"><td>7</td>
<td>-36028797018963967</td>
<td>36028797018963967</td>
</tr>
<tr class="row-odd"><td>8</td>
<td>-9223372036854775807</td>
<td>9223372036854775807</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="unsigned-integer-columns">
<span id="uint-types-index"></span><h3>Unsigned integer columns<a class="headerlink" href="#unsigned-integer-columns" title="Permalink to this headline">¶</a></h3>
<p>Unsigned integer columns with an element size <img class="math" src="_images/math/174fadd07fd54c9afe288e96558c92e0c1da733a.png" alt="n"/>  are <img class="math" src="_images/math/174fadd07fd54c9afe288e96558c92e0c1da733a.png" alt="n"/> byte
unsigned integers. They can store values in the range <img class="math" src="_images/math/e9213b74581a6ff13a8e727f80a5daae3e32f38f.png" alt="0 \leq x
\leq 2^{8n} - 2"/>. Element sizes of <img class="math" src="_images/math/dce34f4dfb2406144304ad0d6106c5382ddd1446.png" alt="1"/> up to <img class="math" src="_images/math/8455f3b5cb3b4880b8c9d782a5c1f0334db819eb.png" alt="8"/> are supported.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="11%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element size</th>
<th class="head">Min</th>
<th class="head">Max</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>0</td>
<td>254</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>0</td>
<td>65534</td>
</tr>
<tr class="row-even"><td>3</td>
<td>0</td>
<td>16777214</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>0</td>
<td>4294967294</td>
</tr>
<tr class="row-even"><td>5</td>
<td>0</td>
<td>1099511627774</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>0</td>
<td>281474976710654</td>
</tr>
<tr class="row-even"><td>7</td>
<td>0</td>
<td>72057594037927934</td>
</tr>
<tr class="row-odd"><td>8</td>
<td>0</td>
<td>18446744073709551614</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="floating-point-columns">
<span id="float-types-index"></span><h3>Floating point columns<a class="headerlink" href="#floating-point-columns" title="Permalink to this headline">¶</a></h3>
<p>Floating point columns represent real numbers using the
<a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_floating_point">IEEE floating point</a>
format. Currently, <img class="math" src="_images/math/c7cab1a05e1e0c1d51a6a219d96577a16b7abf9d.png" alt="4"/> and <img class="math" src="_images/math/8455f3b5cb3b4880b8c9d782a5c1f0334db819eb.png" alt="8"/> byte floating point values
are supported, corresponding to IEEE single and double precision values,
respectively.</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="7%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element size</th>
<th class="head">C type</th>
<th class="head">Details</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>4</td>
<td>float</td>
<td><a class="reference external" href="https://en.wikipedia.org/wiki/Single_precision_floating-point_format">float 32</a></td>
</tr>
<tr class="row-odd"><td>8</td>
<td>double</td>
<td><a class="reference external" href="https://en.wikipedia.org/wiki/Double_precision_floating-point_format">float 64</a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="character-columns">
<h3>Character columns<a class="headerlink" href="#character-columns" title="Permalink to this headline">¶</a></h3>
<p>Character columns store strings of bytes, and are treated in a slightly different way to the numeric
columns seen above. For a character column, the <cite>element_size</cite> must be equal to 1, since
only one-byte character sets are supported. A fixed size of column <cite>num_elements</cite> elements can
therefore store strings of length up to <cite>num_elements</cite>. Variable length <cite>char</cite> columns
can store strings of length 0 to 255 bytes.</p>
</div>
</div>
<div class="section" id="row-format">
<h2>Row format<a class="headerlink" href="#row-format" title="Permalink to this headline">¶</a></h2>
<p>While the low-level details of the binary format used by wormtable are
not of interest to the average programmer, it may be
useful to have a basic understanding of the low-level format when
tuning for performance.</p>
<div class="section" id="row-storage">
<h3>Row storage<a class="headerlink" href="#row-storage" title="Permalink to this headline">¶</a></h3>
<p>Rows hold data from a fixed number of predefined columns, which are together referred
to as a <strong>schema</strong>. A table must have at least two columns, and the first column
must be an unsigned integer column called <tt class="docutils literal"><span class="pre">row_id</span></tt>. This first column contains
the key used by Berkeley DB to store and retrieve rows. The values stored in this column
correspond to the zero-based row index, and they are automatically set by wormtable
when a new row is appended to a table.</p>
<p>The schema is defined using an XML format, which describes the names, types, sizes and
relative positions of the columns in a table.
Suppose we had the following wormtable schema, describing the first three columns of a
VCF file.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<span class="nt">&lt;schema</span> <span class="na">version=</span><span class="s">&quot;0.1&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;columns&gt;</span>
    <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&quot;row_id&quot;</span> <span class="na">element_size=</span><span class="s">&quot;5&quot;</span> <span class="na">element_type=</span><span class="s">&quot;uint&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span> <span class="na">description=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&quot;CHROM&quot;</span> <span class="na">element_size=</span><span class="s">&quot;1&quot;</span> <span class="na">element_type=</span><span class="s">&quot;char&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;var(1)&quot;</span> <span class="na">description=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&quot;POS&quot;</span> <span class="na">element_size=</span><span class="s">&quot;5&quot;</span> <span class="na">element_type=</span><span class="s">&quot;uint&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span> <span class="na">description=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/columns&gt;</span>
<span class="nt">&lt;/schema&gt;</span>
</pre></div>
</div>
<p>In this schema, we have the mandatory <tt class="docutils literal"><span class="pre">row_id</span></tt> unsigned integer column, a <tt class="docutils literal"><span class="pre">CHROM</span></tt> column
which holds variable length character data, and a <tt class="docutils literal"><span class="pre">POS</span></tt> column, which also stores
five byte unsigned integers. When they are stored on disc, rows from this schema look
something like this:</p>
<img alt="The low-level row storage format" class="align-center" src="_images/row-format.png" style="width: 15cm;" />
<p>Rows are divided into two regions: the <strong>fixed</strong> region and the <strong>variable</strong> region.
The fixed region occupies the first part of the row, and each column occupies
a fixed number of bytes within the fixed region. For columns with a fixed number
of elements, the number of bytes they occupy in the
fixed region is <tt class="docutils literal"><span class="pre">num_elements</span> <span class="pre">*</span> <span class="pre">element_size</span></tt>; this is where the data for this
column is stored. Columns with a <em>variable</em> number of elements do not
store their data within the fixed region; instead, they store the <strong>address</strong>
and <strong>number</strong> of elements that are stored in this particular row. Addresses
then point to the variable region, which is filled sequentially as values are
assigned to columns within the row.</p>
<p>In the example above, <tt class="docutils literal"><span class="pre">row_id</span></tt> and <tt class="docutils literal"><span class="pre">POS</span></tt> are both unsigned integers with
an <tt class="docutils literal"><span class="pre">element_size</span></tt> of 5 and <tt class="docutils literal"><span class="pre">num_elements</span></tt> equal to 1, and so they both
occupy exactly 5 bytes within the fixed region (and never use the variable
region). The <tt class="docutils literal"><span class="pre">CHROM</span></tt> column on the other hand has an <tt class="docutils literal"><span class="pre">element_size</span></tt> of
1 byte (as each element is a single character), and has <tt class="docutils literal"><span class="pre">num_elements</span></tt>
equal to <tt class="docutils literal"><span class="pre">var(1)</span></tt>. This means that it is a variable length column
in which one byte is reserved to store the number of elements
stored in the variable region, starting at the address stored in the
fixed region.</p>
<p>Therefore, variable length columns are assigned three bytes in the fixed
region; the first two hold the address where the elements for this column
start, and the third byte holds the number of elements stored. This
format defines the fundamental limits of wormtable&#8217;s row format: since
we have two bytes to describe addresses, rows are a maximum of 64K long.
Similarly, since we have one byte to hold the number of elements in a
variable length column, we store a maximum of 255 elements within
a variable length column.</p>
</div>
<div class="section" id="column-storage">
<h3>Column storage<a class="headerlink" href="#column-storage" title="Permalink to this headline">¶</a></h3>
<p>Values are stored in columns in a portable binary format. This binary format is
very close to the native representation and can be converted into native
types with very little overhead. The packed representation differs between
the element types, but there are two overriding requirements that apply to all
columns:</p>
<ol class="arabic simple">
<li>Missing values must be equal to 0 in the packed format;</li>
<li>Packed values must sort in the same order as the unpacked values.</li>
</ol>
<p>The second requirement is particularly important, as this ensures that
indexes can be constructed by Berkeley DB without requiring a custom
ordering function.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Data storage</a><ul>
<li><a class="reference internal" href="#column-types">Column types</a><ul>
<li><a class="reference internal" href="#integer-columns">Integer columns</a></li>
<li><a class="reference internal" href="#unsigned-integer-columns">Unsigned integer columns</a></li>
<li><a class="reference internal" href="#floating-point-columns">Floating point columns</a></li>
<li><a class="reference internal" href="#character-columns">Character columns</a></li>
</ul>
</li>
<li><a class="reference internal" href="#row-format">Row format</a><ul>
<li><a class="reference internal" href="#row-storage">Row storage</a></li>
<li><a class="reference internal" href="#column-storage">Column storage</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="performance.html"
                        title="previous chapter">Performance tuning</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/data-storage.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="performance.html" title="Performance tuning"
             >previous</a> |</li>
        <li><a href="index.html">wormtable 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, the Wormtable team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>