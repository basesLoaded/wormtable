

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Performance tuning &mdash; wormtable 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="wormtable 0.1.0 documentation" href="index.html" />
    <link rel="next" title="Data storage" href="data-storage.html" />
    <link rel="prev" title="API Documentation" href="api.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="data-storage.html" title="Data storage"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="api.html" title="API Documentation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">wormtable 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="performance-tuning">
<h1>Performance tuning<a class="headerlink" href="#performance-tuning" title="Permalink to this headline">¶</a></h1>
<p>One of the main goals of wormtable is to
provide a high performance platform for processing tables,
but while also keeping things as simple as possible.
While wormtable should be quite efficient
in most cases, there are a few simple things to do which can
improve performance considerably when working with very large
tables.</p>
<div class="section" id="schema-tuning">
<h2>Schema tuning<a class="headerlink" href="#schema-tuning" title="Permalink to this headline">¶</a></h2>
<p>To get the best performance possible from wormtable, it is important that
the rows are as small as possible. This is done by either using the smallest
possible type for a given column, or discarding the column entirely if
it is not needed. Schemas generated using <tt class="docutils literal"><span class="pre">vcf2wt</span></tt> for VCF files are
conservative, and can often be improved on considerably by some hand tuning. By
shaving a few tens of bytes off each row we can sometimes make the table
gigabytes smaller. Since the main thing that slows down wormtable is
reading data off disk, the smaller the table the faster it is.</p>
<p>To tune the schema of a VCF file, we must first use the <tt class="docutils literal"><span class="pre">--generate</span></tt> option in
<tt class="docutils literal"><span class="pre">vcf2wt</span></tt> to generate a candidate schema:</p>
<div class="highlight-python"><pre>$ vcf2wt -g data.vcf schema.xml</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">schema.xml</span></tt> file then contains the automatically generated (conservative)
schema. We can then edit this schema as we see fit, chaning and deleting columns
as we see fit. Once we&#8217;re happy with the schema, we can then build the table
using this new schema using the <tt class="docutils literal"><span class="pre">--schema</span></tt> option:</p>
<div class="highlight-python"><pre>$ vcf2wt -s schema.xml data.vcf data.wt</pre>
</div>
<p>There are many ways in which we can make a more compact schema.
In the following, we&#8217;ll work with a
VCF file  from the Drosophila Genetic Reference Panel (available
<a class="reference external" href="ftp://ftp.hgsc.bcm.edu/DGRP/freeze2_Feb_2013/vcf_files/freeze2.vcf.gz">here</a>),
improving the schema from that automatically generated by <tt class="docutils literal"><span class="pre">vcf2wt</span></tt>.</p>
<p>Consider,
for example, the following segment of the schema generated by
<tt class="docutils literal"><span class="pre">vcf2wt</span></tt>:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;Genotype&quot;</span> <span class="na">element_size=</span><span class="s">&quot;1&quot;</span> <span class="na">element_type=</span><span class="s">&quot;char&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.GT&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;var(1)&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;number of supporting reads&quot;</span> <span class="na">element_size=</span><span class="s">&quot;4&quot;</span> <span class="na">element_type=</span><span class="s">&quot;int&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.SR&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;number of opposing reads&quot;</span> <span class="na">element_size=</span><span class="s">&quot;4&quot;</span> <span class="na">element_type=</span><span class="s">&quot;int&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.OR&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;Genotype quality&quot;</span> <span class="na">element_size=</span><span class="s">&quot;4&quot;</span> <span class="na">element_type=</span><span class="s">&quot;int&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.GQ&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>There are several ways in which this schema is less than optimal. Firstly, we know that
this VCF is for diploids, and so the genotype columns (e.g <tt class="docutils literal"><span class="pre">DGRP-021.GT</span></tt> above)
are always exactly three characters long. Yet, in this schema the number of
elements is <tt class="docutils literal"><span class="pre">var(1)</span></tt>, allowing variable sized strings to be stored in this column. Variable
sized columns have an overhead of three bytes above the actual values stored,
and so in this case we using twice as many bytes as we should be. To rectify this,
we change the <tt class="docutils literal"><span class="pre">num_elements</span></tt> to <tt class="docutils literal"><span class="pre">3</span></tt>:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;Genotype&quot;</span> <span class="na">element_size=</span><span class="s">&quot;1&quot;</span> <span class="na">element_type=</span><span class="s">&quot;char&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.GT&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;3&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>The next two columns are of the number of supporting reads and number of opposing reads
at a variant site, and these are stored using four byte integers. Therefore, these
columns <tt class="docutils literal"><span class="pre">DGRP-021.SR</span></tt> and <tt class="docutils literal"><span class="pre">DGRP-21.OR</span></tt> can store integers in the range
-2147483647 and 2147483647
(see  <a class="reference internal" href="data-storage.html#int-types-index"><em>Integer columns</em></a>)
. This range is far too large. A more suitable type for
these columns are 2 byte unsigned integers, giving a range of
0 to 65534 (see  <a class="reference internal" href="data-storage.html#uint-types-index"><em>Unsigned integer columns</em></a>). The new lines look like:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;number of supporting reads&quot;</span> <span class="na">element_size=</span><span class="s">&quot;2&quot;</span> <span class="na">element_type=</span><span class="s">&quot;uint&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.SR&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;number of opposing reads&quot;</span> <span class="na">element_size=</span><span class="s">&quot;2&quot;</span> <span class="na">element_type=</span><span class="s">&quot;uint&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.OR&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>Finally, we see that the genotype quality column is also a four byte signed integer, when a 1 byte unsigned
integer suffices to store the values in this VCF:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;column</span> <span class="na">description=</span><span class="s">&quot;Genotype quality&quot;</span> <span class="na">element_size=</span><span class="s">&quot;1&quot;</span> <span class="na">element_type=</span><span class="s">&quot;int&quot;</span> <span class="na">name=</span><span class="s">&quot;DGRP-021.GQ&quot;</span> <span class="na">num_elements=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>We have saved a total of 8 bytes over the default schema by making these
changes. This hardly seems worth the effort, but is in fact quite significant
for two reasons. Firstly, every byte save per row really does count when we
are storing millions of rows. Secondly, there are 205 genotypes in this VCF
so we can make a saving of 1640 bytes by applying these changes to all
of the relevant columns.</p>
<p>Another way in which we can save space is to delete columns that we are not interested
in or that don&#8217;t contain any information. For example, in the Drosophila VCF above,
the <tt class="docutils literal"><span class="pre">ID</span></tt> and <tt class="docutils literal"><span class="pre">QUAL</span></tt> columns contain only missing values, and the <tt class="docutils literal"><span class="pre">FILTER</span></tt>
column only contains only <tt class="docutils literal"><span class="pre">PASS</span></tt>. We can simply delete these columns from the
schema, to save another 14 bytes per row.</p>
<p>This tweaking makes a considerable difference.
The source VCF file is 2.8GB when gzip compressed, and 15GB uncompressed. When we
use the automatic schema from <tt class="docutils literal"><span class="pre">vcf2wt</span></tt> the resulting wormtable is 23.5GB.
However, when we make the changes mentioned above, the wormtable requires only
10.2GB.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">It is very important that rows are less than approximately 16K. Over this
threshold, performance degrades considerably.</p>
</div>
</div>
<div class="section" id="cache-tuning">
<span id="performance-cache"></span><h2>Cache tuning<a class="headerlink" href="#cache-tuning" title="Permalink to this headline">¶</a></h2>
<p>It is very important to provide a large cache when creating a
new table or index. The cache size in wormtable roughly controls
the amount of the table that is stored in memory. This
is one of the advanced features offered by Berkeley DB,
and greatly reduces the amount of time required to write
large tables.</p>
<p>As a rule of thumb, it
is a good idea to set aside half of available RAM for cache
when writing new tables.
So, for example, in a system with 16GB of RAM, a good amount of
cache to allocate would be 8GB. This may seem like a very large
amount of memory to dedicate to cache, but the more of the
underlying Berkeley DB that fits into the cache the better
performance will be as we avoid the costly process of writing
pages to disc which may need to be read back in later.
Ideally, we would like to fit the entire DB into memory
while we are generating it, which means we only need to
write each page to disc once.</p>
<p>It is also important to allocate a large cache then creating a new
index, although we rarely need as much as when creating a table.
Most of the time the entire index will fit comfortably in
RAM, which makes writing the index much faster. The cache
size specified is the <em>maximum</em> amount to use, and so
if the index will fit into less memory than we have allocated
for cache, the remaining memory will not be used.</p>
<p>When reading tables, we rarely need as much cache as when
we are writing them  The amount of cache to allocate
to different indexes and to the main table is a subtle issue
and depends very much on the workload. Generally,
for a linear scan of a table very little cache is
required. However, in situations where we are iterating
over rows that are not in table order using an index,
it can be helpful to have a large cache.</p>
<p>For further information, see the discussion on setting cache
sizes for
<a class="reference external" href="http://docs.oracle.com/cd/E17076_02/html/programmer_reference/general_am_conf.html#am_conf_cachesize">Berkeley DB</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Performance tuning</a><ul>
<li><a class="reference internal" href="#schema-tuning">Schema tuning</a></li>
<li><a class="reference internal" href="#cache-tuning">Cache tuning</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="api.html"
                        title="previous chapter">API Documentation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="data-storage.html"
                        title="next chapter">Data storage</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/performance.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="data-storage.html" title="Data storage"
             >next</a> |</li>
        <li class="right" >
          <a href="api.html" title="API Documentation"
             >previous</a> |</li>
        <li><a href="index.html">wormtable 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, the Wormtable team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>